<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.gary.mqtthttpbridge.mapper.PackMapper">
  <resultMap id="BaseResultMap" type="com.gary.mqtthttpbridge.model.Pack">
    <result column="packId" jdbcType="CHAR" property="packId" />
    <result column="current" jdbcType="FLOAT" property="current" />
    <result column="voltage" jdbcType="FLOAT" property="voltage" />
    <result column="insulationResistance" jdbcType="FLOAT" property="insulationresistance" />
    <result column="averageMonomerResistance" jdbcType="FLOAT" property="averagemonomerresistance" />
    <result column="averageMonomerTemperature" jdbcType="FLOAT" property="averagemonomertemperature" />
    <result column="terminalTemperature" jdbcType="FLOAT" property="terminaltemperature" />
    <!--btterypackrealTimechargingpower-->
    <result column="realTimeChargingPower" jdbcType="FLOAT" property="realTimeChargingPower" />
    <!--batteryPackRealtimeDischargingPower-->
    <result column="realTimeDischargingPower" jdbcType="FLOAT" property="realTimedischargingpower" />
    <result column="time" jdbcType="TIMESTAMP" property="time" />
  </resultMap>
  <sql id="Base_Column_List">
    packId, current, voltage, insulationResistance, averageMonomerResistance, averageMonomerTemperature, terminalTemperature, realTimeChargingPower, realTimeDischargingPower, time
  </sql>
  <insert id="insert" parameterType="com.gary.mqtthttpbridge.model.Pack">
    insert into t_pack (packId, `current`, voltage,
      insulationResistance, averageMonomerResistance, 
      averageMonomerTemperature, terminalTemperature, 
      realTimeChargingPower, realTimeDischargingPower,
      `time`)
    values (#{packId,jdbcType=CHAR}, #{current,jdbcType=FLOAT}, #{voltage,jdbcType=FLOAT}, 
      #{insulationresistance,jdbcType=FLOAT}, #{averagemonomerresistance,jdbcType=FLOAT}, 
      #{averagemonomertemperature,jdbcType=FLOAT}, #{terminaltemperature,jdbcType=FLOAT}, 
      #{realTimeChargingPower,jdbcType=FLOAT}, #{realTimedischargingpower,jdbcType=FLOAT},
      NOW())
  </insert>
  <insert id="insertSelective" parameterType="com.gary.mqtthttpbridge.model.Pack">
    insert into t_pack
    <trim prefix="(" suffix=")" suffixOverrides=",">
      <if test="packId != null">
        packId,
      </if>
      <if test="current != null">
        `current`,
      </if>
      <if test="voltage != null">
        voltage,
      </if>
      <if test="insulationresistance != null">
        insulationResistance,
      </if>
      <if test="averagemonomerresistance != null">
        averageMonomerResistance,
      </if>
      <if test="averagemonomertemperature != null">
        averageMonomerTemperature,
      </if>
      <if test="terminaltemperature != null">
        terminalTemperature,
      </if>
      <if test="realTimeChargingPower != null">
        realTimeChargingPower,
      </if>
      <if test="realTimeDischargingPower != null">
        realTimeDischargingPower,
      </if>
      <if test="time != null">
        `time`,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides=",">
      <if test="packId != null">
        #{packId,jdbcType=CHAR},
      </if>
      <if test="current != null">
        #{current,jdbcType=FLOAT},
      </if>
      <if test="voltage != null">
        #{voltage,jdbcType=FLOAT},
      </if>
      <if test="insulationresistance != null">
        #{insulationresistance,jdbcType=FLOAT},
      </if>
      <if test="averagemonomerresistance != null">
        #{averagemonomerresistance,jdbcType=FLOAT},
      </if>
      <if test="averagemonomertemperature != null">
        #{averagemonomertemperature,jdbcType=FLOAT},
      </if>
      <if test="terminaltemperature != null">
        #{terminaltemperature,jdbcType=FLOAT},
      </if>
      <if test="realTimeChargingPower != null">
        #{realTimeChargingPower,jdbcType=FLOAT},
      </if>
      <if test="realTimeDischargingPower != null">
        #{realTimedischargingpower,jdbcType=FLOAT},
      </if>
      <if test="time != null">
        #{time,jdbcType=TIMESTAMP},
      </if>
    </trim>
  </insert>
  <select id="selectOneByTime" resultType="com.gary.mqtthttpbridge.model.Pack">
    select *
    from t_pack
    order by TIME desc
    limit 1
  </select>
    <select id="selectPackAll" resultType="com.gary.mqtthttpbridge.model.Pack">
      SELECT
      <include refid="Base_Column_List" />
      FROM (
             -- 子查询：对每个pack按time降序排序，标记序号
             SELECT
               *,
               ROW_NUMBER() OVER (
                 PARTITION BY packId
                 ORDER BY time DESC
                 ) AS rn  -- rn=1表示该pack中最新的记录
             FROM t_pack
             WHERE packId IN ('pack1', 'pack2', 'pack3', 'pack4',
                               'pack5', 'pack6', 'pack7', 'pack8')  -- 限定8个pack
           ) AS temp
      WHERE rn = 1;  -- 只取每个pack中排序第一（最新）的记录
    </select>
</mapper>