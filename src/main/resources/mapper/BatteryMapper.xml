<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.gary.mqtthttpbridge.mapper.BatteryMapper">
  <resultMap id="BaseResultMap" type="com.gary.mqtthttpbridge.model.Battery">
    <result column="current" jdbcType="FLOAT" property="current" />
    <result column="voltage" jdbcType="FLOAT" property="voltage" />
    <result column="temperature" jdbcType="FLOAT" property="temperature" />
    <result column="time" jdbcType="TIMESTAMP" property="time" />
    <result column="batteryId" jdbcType="CHAR" property="batteryId" />
  </resultMap>
  <sql id="Base_Column_List">
    current, voltage, temperature, time, batteryId
  </sql>
  <insert id="insert" parameterType="com.gary.mqtthttpbridge.model.Battery">
    insert into t_battery (`current`, voltage, temperature, 
      `time`, batteryId)
    values (#{current,jdbcType=FLOAT}, #{voltage,jdbcType=FLOAT}, #{temperature,jdbcType=FLOAT}, 
      NOW(), #{batteryId,jdbcType=CHAR})
  </insert>
  <insert id="insertSelective" parameterType="com.gary.mqtthttpbridge.model.Battery">
    insert into t_battery
    <trim prefix="(" suffix=")" suffixOverrides=",">
      <if test="current != null">
        `current`,
      </if>
      <if test="voltage != null">
        voltage,
      </if>
      <if test="temperature != null">
        temperature,
      </if>
      <if test="time != null">
        `time`,
      </if>
      <if test="batteryId != null">
        batteryId,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides=",">
      <if test="current != null">
        #{current,jdbcType=FLOAT},
      </if>
      <if test="voltage != null">
        #{voltage,jdbcType=FLOAT},
      </if>
      <if test="temperature != null">
        #{temperature,jdbcType=FLOAT},
      </if>
      <if test="time != null">
        #{time,jdbcType=TIMESTAMP},
      </if>
      <if test="batteryId != null">
        #{batteryId,jdbcType=CHAR},
      </if>
    </trim>
  </insert>
  <select id="selectOneByTime" resultType="com.gary.mqtthttpbridge.model.Battery">
    select
    <include refid="Base_Column_List" />
    from t_battery
    order by TIME desc
    limit 1
  </select>
  <select id="selectLatestByPack" resultType="com.gary.mqtthttpbridge.model.Battery">
    -- 传入参数：pack_num（1-8），查询该pack下14个电芯的最新数据
    SELECT
    <include refid="Base_Column_List" />
    FROM (
           -- 子查询：对每个电芯按时间排序，标记最新记录
           SELECT
             *,
             ROW_NUMBER() OVER (
               PARTITION BY batteryId  -- 按电芯ID分组
               ORDER BY time DESC       -- 按时间降序（最新的排第一）
               ) AS rn
           FROM mqtt_http_bridge.t_battery
           -- 筛选指定pack的电芯（battery-id格式：battery-{pack_num}-{1-14}）
           WHERE batteryId REGEXP CONCAT('^battery-', #{packNum}, '-\\d+$')
         ) AS temp
    WHERE rn = 1;  -- 只取每个电芯的最新记录（rn=1）
  </select>
</mapper>